name: Build and Release Multi-platform Installers

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  APP_NAME: JavaFXApp

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Install frontend dependencies
      run: |
        cd front
        npm ci
        
    - name: Build frontend
      run: |
        cd front
        npm run build-and-copy
        
    - name: Build with Maven
      run: |
        cd application
        mvn clean compile -DskipTests
        
    - name: Run tests
      run: |
        cd application
        mvn test

  build-windows:
    name: Build Windows Installer
    needs: build-and-test
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Install frontend dependencies
      run: |
        cd front
        npm ci
      shell: cmd
      
    - name: Build frontend
      run: |
        cd front
        npm run build-and-copy
      shell: cmd
      
    - name: Build Windows installer with Maven
      run: |
        cd application
        mvn clean package -DskipTests -Pwindows
      shell: cmd
      
    - name: Debug - List target directory
      run: |
        echo "=== Target directory contents ==="
        dir application\target
      shell: cmd
      
    - name: Debug - List installers directory
      run: |
        echo "=== Installers directory contents ==="
        if exist application\target\installers\windows (
          dir application\target\installers\windows
        ) else (
          echo Windows installers directory does not exist
          rem 查找所有exe文件
          dir application\*.exe /s 2>nul || echo No exe files found
          dir application\target\*.exe /s 2>nul || echo No exe files found in target
        )
      shell: cmd
      
    - name: Check for exe files in target directory
      run: |
        echo "=== Looking for exe files in target ==="
        dir application\target\*.exe /s 2>nul || echo No exe files found in target directory
      shell: cmd
      
    - name: Check for exe files in target installers directory
      run: |
        echo "=== Looking for exe files in installers ==="
        if exist application\target\installers (
          dir application\target\installers\*.exe /s 2>nul || echo No exe files found in installers directory
        ) else (
          echo Installers directory does not exist
        )
      shell: cmd
      
    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: |
          application/target/installers/windows/*.exe
          application/target/*.exe
        retention-days: 7

  build-linux:
    name: Build Linux Installer
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Install frontend dependencies
      run: |
        cd front
        npm ci
        
    - name: Build frontend
      run: |
        cd front
        npm run build-and-copy
        
    - name: Build Linux installer with Maven
      run: |
        cd application
        mvn clean package -DskipTests -Plinux
        
    - name: Debug - List target directory
      run: |
        echo "=== Target directory contents ==="
        ls -la application/target/
        
    - name: Debug - List installers directory
      run: |
        echo "=== Installers directory contents ==="
        if [ -d "application/target/installers/linux" ]; then
          ls -la application/target/installers/linux/
        else
          echo "Linux installers directory does not exist"
          # 查找所有deb文件
          find application/ -name "*.deb" -type f 2>/dev/null || echo "No deb files found"
          find application/target/ -name "*.deb" -type f 2>/dev/null || echo "No deb files found in target"
        fi
        
    - name: Upload Linux installer
      uses: actions/upload-artifact@v4
      with:
        name: linux-installer
        path: |
          application/target/installers/linux/*.deb
          application/target/*.deb
        retention-days: 7

  build-macos-intel:
    name: Build macOS Intel Installer
    needs: build-and-test
    runs-on: macos-13  # Intel-based macOS
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Install frontend dependencies
      run: |
        cd front
        npm ci
        
    - name: Build frontend
      run: |
        cd front
        npm run build-and-copy
        
    - name: Build macOS Intel installer with Maven
      run: |
        cd application
        mvn clean package -DskipTests -Pmac-intel
        
    - name: Debug - List target directory
      run: |
        ls -la application/target/
        
    - name: Debug - List installers directory
      run: |
        if [ -d "application/target/installers/mac-intel" ]; then
          ls -la application/target/installers/mac-intel/
        else
          echo "macOS Intel installers directory does not exist"
          # 查找所有dmg文件
          find application/ -name "*.dmg" -type f 2>/dev/null || echo "No dmg files found"
          find application/target/ -name "*.dmg" -type f 2>/dev/null || echo "No dmg files found in target"
        fi
        
    - name: Upload macOS Intel installer
      uses: actions/upload-artifact@v4
      with:
        name: macos-intel-installer
        path: |
          application/target/installers/mac-intel/*.dmg
          application/target/*.dmg
        retention-days: 7
        
  build-macos-arm:
    name: Build macOS ARM Installer
    needs: build-and-test
    runs-on: macos-latest  # ARM-based macOS (Apple Silicon)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Install frontend dependencies
      run: |
        cd front
        npm ci
        
    - name: Build frontend
      run: |
        cd front
        npm run build-and-copy
        
    - name: Build macOS ARM installer with Maven
      run: |
        cd application
        mvn clean package -DskipTests -Pmac-arm
        
    - name: Debug - List target directory
      run: |
        ls -la application/target/
        
    - name: Debug - List installers directory
      run: |
        if [ -d "application/target/installers/mac-arm" ]; then
          ls -la application/target/installers/mac-arm/
        else
          echo "macOS ARM installers directory does not exist"
          # 查找所有dmg文件
          find application/ -name "*.dmg" -type f 2>/dev/null || echo "No dmg files found"
          find application/target/ -name "*.dmg" -type f 2>/dev/null || echo "No dmg files found in target"
        fi
        
    - name: Upload macOS ARM installer
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm-installer
        path: |
          application/target/installers/mac-arm/*.dmg
          application/target/*.dmg
        retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-linux, build-macos-intel, build-macos-arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
      
    - name: Set release version from pom.xml
      run: |
        # 从pom.xml中提取版本号
        VERSION=$(cd application && mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
        
        # 如果是标签推送，则使用标签名，否则创建基于提交时间格式化的唯一标签名
        if [[ "${{ github.ref_type }}" == 'tag' ]]; then
          TAG_NAME="${{ github.ref_name }}"
        else
          # 获取提交时间并格式化为 YYYYMMDD-HHMMSS
          COMMIT_TIME=$(git show -s --format=%cd --date=format:%Y%m%d-%H%M%S HEAD)
          TAG_NAME="v$VERSION-release-$COMMIT_TIME"
        fi
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
        
        # 删除已存在的Release和标签（如果存在）
        gh release delete "$TAG_NAME" --yes 2>/dev/null || true
        git push origin --delete "$TAG_NAME" 2>/dev/null || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG_NAME }}
        release_name: Release v${{ env.RELEASE_VERSION }}
        draft: false
        prerelease: false

    - name: Download all installers
      uses: actions/download-artifact@v4
      
    - name: Display downloaded files
      run: |
        echo "=== Downloaded artifacts ==="
        ls -la
        for dir in */; do
          if [ -d "$dir" ]; then
            echo "=== $dir ==="
            ls -la "$dir"
          fi
        done
        
    - name: Upload Windows installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./windows-installer/*.exe
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-windows.exe
        asset_content_type: application/vnd.microsoft.portable-executable
      continue-on-error: true
        
    - name: Upload Linux installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./linux-installer/*.deb
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-linux.deb
        asset_content_type: application/vnd.debian.binary-package
      continue-on-error: true
        
    - name: Upload macOS Intel installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./macos-intel-installer/*.dmg
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-macos-intel.dmg
        asset_content_type: application/octet-stream
      continue-on-error: true
        
    - name: Upload macOS ARM installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./macos-arm-installer/*.dmg
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-macos-arm.dmg
        asset_content_type: application/octet-stream
      continue-on-error: true