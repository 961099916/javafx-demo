name: Build and Release Multi-platform Installers

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  APP_NAME: JavaFXApp

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Install frontend dependencies
      run: |
        echo "=== Installing frontend dependencies ==="
        cd front
        npm ci
        echo "=== Frontend dependencies installed successfully ==="
        
    - name: Build frontend
      run: |
        echo "=== Building frontend ==="
        cd front
        npm run build-and-copy
        echo "=== Frontend built and copied successfully ==="
        
    - name: Build with Maven
      run: |
        echo "=== Building with Maven ==="
        cd application
        mvn clean compile -DskipTests
        echo "=== Maven build completed successfully ==="
        
    - name: Run tests
      run: |
        echo "=== Running tests ==="
        cd application
        mvn test
        echo "=== Tests completed ==="

  build-windows:
    name: Build Windows Installer
    needs: build-and-test
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Install frontend dependencies
      run: |
        echo "=== Installing frontend dependencies ==="
        cd front
        npm ci
        echo "=== Frontend dependencies installed successfully ==="
      shell: cmd
      
    - name: Build frontend
      run: |
        echo "=== Building frontend ==="
        cd front
        npm run build-and-copy
        echo "=== Frontend built and copied successfully ==="
      shell: cmd
      
    - name: Build Windows installer with Maven
      run: |
        echo "=== Building Windows installer with Maven ==="
        cd application
        mvn clean package -DskipTests -Pwindows
        echo "=== Windows installer built successfully ==="
      shell: cmd
      
    - name: Debug - List target directory
      run: |
        echo "=== Target directory contents ==="
        dir application\target
      shell: cmd
      
    - name: Debug - List installers directory
      run: |
        echo "=== Installers directory contents ==="
        if exist application\target\installers\windows (
          dir application\target\installers\windows
        ) else (
          echo Windows installers directory does not exist
          rem 查找所有exe文件
          dir application\*.exe /s 2>nul || echo No exe files found
          dir application\target\*.exe /s 2>nul || echo No exe files found in target
        )
      shell: cmd
      
    - name: Ensure installers directory exists
      run: |
        echo "=== Ensuring installers directory exists ==="
        if not exist "application\target\installers\windows" mkdir "application\target\installers\windows"
        echo "=== Moving EXE files to installers directory ==="
        rem 检查是否有exe文件在其他位置，如果有则移动到正确位置
        for /r application\target %%f in (*.exe) do (
          if not exist "application\target\installers\windows\%%~nxf" (
            echo Moving %%f to installers directory
            move "%%f" "application\target\installers\windows\" >nul 2>&1 || echo Failed to move %%f
          ) else (
            echo File %%~nxf already exists in installers directory
          )
        )
        echo "=== Installers directory setup completed ==="
      shell: cmd
      
    - name: List final installers directory
      run: |
        echo "=== Final installers directory contents ==="
        if exist application\target\installers\windows (
          dir application\target\installers\windows
        ) else (
          echo Windows installers directory does not exist
        )
      shell: cmd
      
    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: |
          application/target/installers/windows/*.exe
          application/target/*.exe
        retention-days: 7

  build-linux:
    name: Build Linux Installer
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Install frontend dependencies
      run: |
        cd front
        npm ci
        
    - name: Build frontend
      run: |
        cd front
        npm run build-and-copy
        
    - name: Build Linux installer with Maven
      run: |
        echo "=== Building Linux installer with Maven ==="
        cd application
        mvn clean package -DskipTests -Plinux
        echo "=== Linux installer built successfully ==="
        
    - name: Debug - List target directory
      run: |
        echo "=== Target directory contents ==="
        ls -la application/target/
        
    - name: Debug - List installers directory
      run: |
        echo "=== Installers directory contents ==="
        if [ -d "application/target/installers/linux" ]; then
          ls -la application/target/installers/linux/
        else
          echo "Linux installers directory does not exist"
          # 查找所有deb文件
          find application/ -name "*.deb" -type f 2>/dev/null || echo "No deb files found"
          find application/target/ -name "*.deb" -type f 2>/dev/null || echo "No deb files found in target"
        fi
        
    - name: Ensure installers directory exists
      run: |
        echo "=== Ensuring installers directory exists ==="
        mkdir -p application/target/installers/linux
        echo "=== Moving DEB files to installers directory ==="
        # 检查是否有deb文件在其他位置，如果有则移动到正确位置
        find application/target/ -name "*.deb" -type f -exec sh -c 'filename=$(basename "$1"); if [ ! -f "application/target/installers/linux/$filename" ]; then echo "Moving $1 to installers directory"; mv "$1" application/target/installers/linux/ 2>/dev/null || echo "Failed to move $1"; else echo "File $filename already exists in installers directory"; fi' _ {} \; || echo "Failed to move some DEB files"
        echo "=== Installers directory setup completed ==="
        
    - name: List final installers directory
      run: |
        echo "=== Final installers directory contents ==="
        if [ -d "application/target/installers/linux" ]; then
          ls -la application/target/installers/linux/
        else
          echo "Linux installers directory does not exist"
        fi
        
    - name: Upload Linux installer
      uses: actions/upload-artifact@v4
      with:
        name: linux-installer
        path: |
          application/target/installers/linux/*.deb
          application/target/*.deb
        retention-days: 7

  build-macos-intel:
    name: Build macOS Intel Installer
    needs: build-and-test
    runs-on: macos-13  # Intel-based macOS
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Install frontend dependencies
      run: |
        cd front
        npm ci
        
    - name: Build frontend
      run: |
        cd front
        npm run build-and-copy
        
    - name: Build macOS Intel installer with Maven
      run: |
        echo "=== Building macOS Intel installer with Maven ==="
        cd application
        mvn clean package -DskipTests -Pmac-intel
        echo "=== macOS Intel installer built successfully ==="
        
    - name: Debug - List target directory
      run: |
        ls -la application/target/
        
    - name: Debug - List installers directory
      run: |
        if [ -d "application/target/installers/mac-intel" ]; then
          ls -la application/target/installers/mac-intel/
        else
          echo "macOS Intel installers directory does not exist"
          # 查找所有dmg文件
          find application/ -name "*.dmg" -type f 2>/dev/null || echo "No dmg files found"
          find application/target/ -name "*.dmg" -type f 2>/dev/null || echo "No dmg files found in target"
        fi
        
    - name: Ensure installers directory exists
      run: |
        echo "=== Ensuring installers directory exists ==="
        mkdir -p application/target/installers/mac-intel
        echo "=== Moving DMG files to installers directory ==="
        # 检查是否有dmg文件在其他位置，如果有则移动到正确位置
        find application/target/ -name "*.dmg" -type f -exec sh -c 'filename=$(basename "$1"); if [ ! -f "application/target/installers/mac-intel/$filename" ]; then echo "Moving $1 to installers directory"; mv "$1" application/target/installers/mac-intel/ 2>/dev/null || echo "Failed to move $1"; else echo "File $filename already exists in installers directory"; fi' _ {} \; || echo "Failed to move some DMG files"
        echo "=== Installers directory setup completed ==="
        
    - name: List final installers directory
      run: |
        echo "=== Final installers directory contents ==="
        if [ -d "application/target/installers/mac-intel" ]; then
          ls -la application/target/installers/mac-intel/
        else
          echo "macOS Intel installers directory does not exist"
        fi
        
    - name: Upload macOS Intel installer
      uses: actions/upload-artifact@v4
      with:
        name: macos-intel-installer
        path: |
          application/target/installers/mac-intel/*.dmg
          application/target/*.dmg
        retention-days: 7
        
  build-macos-arm:
    name: Build macOS ARM Installer
    needs: build-and-test
    runs-on: macos-latest  # ARM-based macOS (Apple Silicon)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: front/package-lock.json
        
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Install frontend dependencies
      run: |
        cd front
        npm ci
        
    - name: Build frontend
      run: |
        cd front
        npm run build-and-copy
        
    - name: Build macOS ARM installer with Maven
      run: |
        echo "=== Building macOS ARM installer with Maven ==="
        cd application
        mvn clean package -DskipTests -Pmac-arm
        echo "=== macOS ARM installer built successfully ==="
        
    - name: Debug - List target directory
      run: |
        ls -la application/target/
        
    - name: Debug - List installers directory
      run: |
        if [ -d "application/target/installers/mac-arm" ]; then
          ls -la application/target/installers/mac-arm/
        else
          echo "macOS ARM installers directory does not exist"
          # 查找所有dmg文件
          find application/ -name "*.dmg" -type f 2>/dev/null || echo "No dmg files found"
          find application/target/ -name "*.dmg" -type f 2>/dev/null || echo "No dmg files found in target"
        fi
        
    - name: Ensure installers directory exists
      run: |
        echo "=== Ensuring installers directory exists ==="
        mkdir -p application/target/installers/mac-arm
        echo "=== Moving DMG files to installers directory ==="
        # 检查是否有dmg文件在其他位置，如果有则移动到正确位置
        find application/target/ -name "*.dmg" -type f -exec sh -c 'filename=$(basename "$1"); if [ ! -f "application/target/installers/mac-arm/$filename" ]; then echo "Moving $1 to installers directory"; mv "$1" application/target/installers/mac-arm/ 2>/dev/null || echo "Failed to move $1"; else echo "File $filename already exists in installers directory"; fi' _ {} \; || echo "Failed to move some DMG files"
        echo "=== Installers directory setup completed ==="
        
    - name: List final installers directory
      run: |
        echo "=== Final installers directory contents ==="
        if [ -d "application/target/installers/mac-arm" ]; then
          ls -la application/target/installers/mac-arm/
        else
          echo "macOS ARM installers directory does not exist"
        fi
        
    - name: Upload macOS ARM installer
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm-installer
        path: |
          application/target/installers/mac-arm/*.dmg
          application/target/*.dmg
        retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-linux, build-macos-intel, build-macos-arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
      
    - name: Set release version from pom.xml
      run: |
        # 从pom.xml中提取版本号
        VERSION=$(cd application && mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
        
        # 如果是标签推送，则使用标签名，否则创建基于提交时间格式化的唯一标签名
        if [[ "${{ github.ref_type }}" == 'tag' ]]; then
          TAG_NAME="${{ github.ref_name }}"
        else
          # 获取提交时间并格式化为 YYYYMMDD-HHMMSS
          COMMIT_TIME=$(git show -s --format=%cd --date=format:%Y%m%d-%H%M%S HEAD)
          TAG_NAME="v$VERSION-release-$COMMIT_TIME"
        fi
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
        
        # 删除已存在的Release和标签（如果存在）
        gh release delete "$TAG_NAME" --yes 2>/dev/null || true
        git push origin --delete "$TAG_NAME" 2>/dev/null || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG_NAME }}
        release_name: Release v${{ env.RELEASE_VERSION }}
        draft: false
        prerelease: false
        
    - name: Download all installers
      uses: actions/download-artifact@v4
      
    - name: Display downloaded files structure
      run: |
        echo "=== Current directory structure ==="
        pwd
        ls -la
        echo "=== Detailed directory listing ==="
        find . -type d | sort
        echo "=== All files ==="
        find . -type f | sort
        
    - name: Check specific installer directories
      run: |
        echo "=== Checking windows-installer directory ==="
        if [ -d "windows-installer" ]; then
          ls -la windows-installer/
          echo "EXE files in windows-installer:"
          find windows-installer/ -name "*.exe" -type f 2>/dev/null || echo "No EXE files found"
        else
          echo "windows-installer directory does not exist"
        fi
        
        echo "=== Checking linux-installer directory ==="
        if [ -d "linux-installer" ]; then
          ls -la linux-installer/
          echo "DEB files in linux-installer:"
          find linux-installer/ -name "*.deb" -type f 2>/dev/null || echo "No DEB files found"
        else
          echo "linux-installer directory does not exist"
        fi
        
        echo "=== Checking macos-intel-installer directory ==="
        if [ -d "macos-intel-installer" ]; then
          ls -la macos-intel-installer/
          echo "DMG files in macos-intel-installer:"
          find macos-intel-installer/ -name "*.dmg" -type f 2>/dev/null || echo "No DMG files found"
        else
          echo "macos-intel-installer directory does not exist"
        fi
        
        echo "=== Checking macos-arm-installer directory ==="
        if [ -d "macos-arm-installer" ]; then
          ls -la macos-arm-installer/
          echo "DMG files in macos-arm-installer:"
          find macos-arm-installer/ -name "*.dmg" -type f 2>/dev/null || echo "No DMG files found"
        else
          echo "macos-arm-installer directory does not exist"
        fi
        
    - name: Find and list all installer files
      run: |
        echo "=== Finding all installer files ==="
        find . -name "*.exe" -o -name "*.deb" -o -name "*.dmg" | while read file; do
          echo "Found installer: $file"
          ls -lh "$file"  # 显示文件详细信息
        done
        
    - name: Count installer files
      run: |
        echo "=== Counting installer files ==="
        echo "Windows EXE files: $(find . -name "*.exe" -type f | wc -l)"
        echo "Linux DEB files: $(find . -name "*.deb" -type f | wc -l)"
        echo "macOS DMG files: $(find . -name "*.dmg" -type f | wc -l)"
        
    - name: Upload Windows installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: windows-installer/*.exe
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-windows.exe
        asset_content_type: application/vnd.microsoft.portable-executable
      continue-on-error: true
      if: hashFiles('windows-installer/*.exe') != ''
        
    - name: Upload Linux installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: linux-installer/*.deb
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-linux.deb
        asset_content_type: application/vnd.debian.binary-package
      continue-on-error: true
      if: hashFiles('linux-installer/*.deb') != ''
        
    - name: Upload macOS Intel installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: macos-intel-installer/*.dmg
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-macos-intel.dmg
        asset_content_type: application/octet-stream
      continue-on-error: true
      if: hashFiles('macos-intel-installer/*.dmg') != ''
        
    - name: Upload macOS ARM installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: macos-arm-installer/*.dmg
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-macos-arm.dmg
        asset_content_type: application/octet-stream
      continue-on-error: true
      if: hashFiles('macos-arm-installer/*.dmg') != ''
