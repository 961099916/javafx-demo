name: Build and Release Multi-platform Installers

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

env:
  APP_NAME: JavaFXApp

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Build with Maven
      run: |
        mvn clean compile -DskipTests
        
    - name: Run tests
      run: |
        mvn test

  build-windows:
    name: Build Windows Installer
    needs: build-and-test
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Build Windows installer with Maven
      run: |
        mvn clean package -DskipTests -Pwindows
      shell: cmd
      
    - name: List target directory
      run: |
        dir target
      shell: cmd
      
    - name: List installers directory
      run: |
        if exist target\installers dir target\installers
        if not exist target\installers echo "Installers directory does not exist"
      shell: cmd
      
    - name: List windows installers directory
      run: |
        if exist target\installers\windows dir target\installers\windows
        if not exist target\installers\windows echo "Windows installers directory does not exist"
      shell: cmd
      
    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: target/installers/windows/*.exe
        retention-days: 7

  build-linux:
    name: Build Linux Installer
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Build Linux installer with Maven
      run: |
        mvn clean package -DskipTests -Plinux
        
    - name: List target directory
      run: |
        ls -la target/
        
    - name: List installers directory
      run: |
        if [ -d "target/installers" ]; then
          ls -la target/installers/
        else
          echo "Installers directory does not exist"
        fi
        
    - name: List linux installers directory
      run: |
        if [ -d "target/installers/linux" ]; then
          ls -la target/installers/linux/
        else
          echo "Linux installers directory does not exist"
        fi
        
    - name: Upload Linux installer
      uses: actions/upload-artifact@v4
      with:
        name: linux-installer
        path: target/installers/linux/*.deb
        retention-days: 7

  build-macos-intel:
    name: Build macOS Intel Installer
    needs: build-and-test
    runs-on: macos-13  # Intel-based macOS
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Build macOS Intel installer with Maven
      run: |
        mvn clean package -DskipTests -Pmac-intel
        
    - name: List target directory
      run: |
        ls -la target/
        
    - name: List installers directory
      run: |
        if [ -d "target/installers" ]; then
          ls -la target/installers/
        else
          echo "Installers directory does not exist"
        fi
        
    - name: List mac intel installers directory
      run: |
        if [ -d "target/installers/mac-intel" ]; then
          ls -la target/installers/mac-intel/
        else
          echo "macOS Intel installers directory does not exist"
        fi
        
    - name: Upload macOS Intel installer
      uses: actions/upload-artifact@v4
      with:
        name: macos-intel-installer
        path: target/installers/mac-intel/*.dmg
        retention-days: 7
        
  build-macos-arm:
    name: Build macOS ARM Installer
    needs: build-and-test
    runs-on: macos-latest  # ARM-based macOS (Apple Silicon)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
        
    - name: Build macOS ARM installer with Maven
      run: |
        mvn clean package -DskipTests -Pmac-arm
        
    - name: List target directory
      run: |
        ls -la target/
        
    - name: List installers directory
      run: |
        if [ -d "target/installers" ]; then
          ls -la target/installers/
        else
          echo "Installers directory does not exist"
        fi
        
    - name: List mac arm installers directory
      run: |
        if [ -d "target/installers/mac-arm" ]; then
          ls -la target/installers/mac-arm/
        else
          echo "macOS ARM installers directory does not exist"
        fi
        
    - name: Upload macOS ARM installer
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm-installer
        path: target/installers/mac-arm/*.dmg
        retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: [build-windows, build-linux, build-macos-intel, build-macos-arm]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
      
    - name: Set release version from pom.xml
      run: |
        # 从pom.xml中提取版本号
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
        
        # 如果是标签推送，则使用标签名，否则创建基于提交SHA的唯一标签名
        if [[ "${{ github.ref_type }}" == 'tag' ]]; then
          TAG_NAME="${{ github.ref_name }}"
        else
          TAG_NAME="v$VERSION-release-${{ github.sha }}"
        fi
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
        
        # 删除已存在的Release和标签（如果存在）
        gh release delete "$TAG_NAME" --yes 2>/dev/null || true
        git push origin --delete "$TAG_NAME" 2>/dev/null || true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG_NAME }}
        release_name: Release v${{ env.RELEASE_VERSION }}
        draft: false
        prerelease: false

    - name: Download all installers
      uses: actions/download-artifact@v4
      
    - name: Display downloaded files
      run: |
        echo "=== Downloaded artifacts ==="
        ls -la
        echo "=== Windows installer ==="
        if [ -d "windows-installer" ]; then
          ls -la windows-installer/
        else
          echo "Windows installer directory not found"
        fi
        echo "=== Linux installer ==="
        if [ -d "linux-installer" ]; then
          ls -la linux-installer/
        else
          echo "Linux installer directory not found"
        fi
        echo "=== macOS Intel installer ==="
        if [ -d "macos-intel-installer" ]; then
          ls -la macos-intel-installer/
        else
          echo "macOS Intel installer directory not found"
        fi
        echo "=== macOS ARM installer ==="
        if [ -d "macos-arm-installer" ]; then
          ls -la macos-arm-installer/
        else
          echo "macOS ARM installer directory not found"
        fi
        
    - name: Upload Windows installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: windows-installer/*.exe
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-windows.exe
        asset_content_type: application/vnd.microsoft.portable-executable
      continue-on-error: true
        
    - name: Upload Linux installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: linux-installer/*.deb
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-linux.deb
        asset_content_type: application/vnd.debian.binary-package
      continue-on-error: true
        
    - name: Upload macOS Intel installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: macos-intel-installer/*.dmg
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-macos-intel.dmg
        asset_content_type: application/octet-stream
      continue-on-error: true
        
    - name: Upload macOS ARM installer to release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: macos-arm-installer/*.dmg
        asset_name: ${{ env.APP_NAME }}-v${{ env.RELEASE_VERSION }}-macos-arm.dmg
        asset_content_type: application/octet-stream
      continue-on-error: true